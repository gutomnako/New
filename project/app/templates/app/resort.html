{% extends 'main.html' %}
{% load static %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMB Resort</title>
    <link rel="stylesheet" href="{% static 'styles/resort.css'%}">
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
{% include 'navbar.html' %}
<body>
    <form action="{% url 'update_resort' resort.id %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
    
       <!-- Hero Section -->
<header class="hero" id="hero" style="background-image: url('{% if resort.hero_image %}{{ resort.hero_image.url }}{% else %}/static/images/fmb.jpg{% endif %}');">
    <div class="hero-content">
        <h1>Welcome to {{ resort.name }}</h1>

        <!-- Mini Description (Editable) -->
        <div class="hero-description-wrapper">
            <p id="hero-subtitle">{{ resort.mini_description }}</p>
            <textarea name="mini_description" id="edit-hero-subtitle-input" class="editable-textarea" style="display: none;">{{ resort.mini_description }}</textarea>
            <div class="description-buttons">
                {% if request.user == resort.host %}
               <button type="button" id="edit-hero-btn" class="btn btn-primary me-2">
                Edit Description
            </button>
            <button type="submit" id="save-hero-btn" class="btn btn-success" style="display: none;">
                Save Description
            </button>
                {% endif %}
            </div>
        </div>
        {% if request.user == resort.host %}
        <!-- Upload Hero Image -->
        <label for="uploadHeroImageHero" class="custom-file-upload">Upload Image</label>
        <input type="file" name="hero_image" id="uploadHeroImageHero" accept="image/*" hidden>
        <button type="submit" class="btn btn-primary px-4 py-2 rounded-3">
            Save Hero Image
        </button>
        {% endif %}
    </div>
</header>
    
        <!-- Resort Description Section -->
        <section class="resort-description">
            <div class="description-container">
                <div class="description-text">
                    <h2 style="color: black;">About {{ resort.name }}</h2>
                    <p id="resort-description" style="color: black;">{{ resort.description }}</p>
                    {% if request.user == resort.host %}
                    <textarea name="description" id="edit-description-input" style="display: none;">{{ resort.description }}</textarea>
                    <button type="button" id="edit-description-btn" class="btn btn-warning me-2">
                        Edit Description
                    </button>
                    <button type="submit" id="save-description-btn" class="btn btn-success" style="display: none;">
                        Save Description
                    </button>
                    {% endif %}
                </div>
    
                <!-- Resort Image Upload -->
                <div class="description-image">
                    <img id="resort-image" src="{{ resort.resort_image.url|default:'/static/images/fmb.jpg' }}" alt="Resort Image">
                    {% if request.user == resort.host %}
                    <label for="uploadResortImage" class="custom-file-upload">Upload Image</label>
                    <input type="file" name="resort_image" id="uploadResortImage" accept="image/*">
                    <button type="submit" id="save-resort-image-btn" class="btn btn-primary px-4 py-2 rounded-3 shadow-sm">
                        Save Resort Image
                    </button>
                    {% endif %}
                </div>
            </div>
        </section>
    
        <!-- Rooms Section -->
<div class="rooms-container" style="background: linear-gradient(to bottom right, #1f5d63, #3f8ca0); padding: 60px 40px; color: white;">
    <section class="room-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <div class="slider-container" data-resort-id="{{ resort.id }}" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;" id="roomSlider">
                    {% for room_image in resort.room_images.all|slice:":3" %}
                        <div class="room-image-container">
                            <img src="{{ room_image.image.url }}" alt="Room Image" class="room-slide {% if forloop.first %}active{% endif %}" data-image-id="{{ room_image.id }}">
                        {% if request.user == resort.host %}
                            {% if forloop.counter == 1 %}
                                <button class="replace-button" data-image-id="{{ room_image.id }}" style="display:block;">Replace Image</button>
                            {% else %}
                                <button class="replace-button" data-image-id="{{ room_image.id }}" style="display:none;">Replace Image</button>
                            {% endif %}
                        {% endif %}
                        </div>
                    {% empty %}
                        <img src="/static/images/fmb.jpg" alt="Default Room Image" class="room-slide active" data-image-id="default-room-1">
                    {% endfor %}
                    
                    <!-- Arrows -->
                    <button class="prev" type="button" style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10094;</button>
                    <button class="next" type="button" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10095;</button>
                </div>
            
                <!-- Upload form -->
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                        <label for="uploadRoomImage" class="custom-file-upload">Upload Image</label>
                        <input type="file" name="room_image" id="uploadRoomImage" accept="image/*">
                        <button type="button" id="save-room-image-btn" class="btn btn-success px-4 py-2 rounded-3 shadow-sm">
                            Save Room Image
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Description Right -->
            <div class="description-text" style="flex: 1; max-width: 50%; margin-left: 40px;">
                <h2 style="color: white; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Rooms and Cottages</h2>
                <p id="room-description" style="font-size: 17px; line-height: 1.6;">{{ resort.room_description }}</p>
                <textarea name="room_description" id="edit-room-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.room_description }}</textarea>
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                    <button type="button" id="edit-room-description-btn" class="btn btn-warning me-2">
                        Edit Room Description
                    </button>
                    <button type="submit" id="save-room-description-btn" class="btn btn-success" style="display: none;">
                        Save Room Description
                    </button>
                    {% endif %}
                </div>
            </div>

        </div>
    </section>
</div>

<!-- Beach Section -->
<div class="beach-container" style="background: #f5f5f5; padding: 60px 40px; color: #333;">
    <section class="beach-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <!-- Text Left -->
            <div class="description-text" style="flex: 1; max-width: 50%; margin-right: 40px;">
                <h2 style="color: #333; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Beach</h2>
                <p id="beach-description" style="font-size: 17px; line-height: 1.6; color: #333;">{{ resort.beach_description }}</p>
                <textarea name="beach_description" id="edit-beach-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.beach_description }}</textarea>
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                    <button type="button" id="edit-beach-description-btn" class="btn btn-warning me-2">
                        Edit Beach Description
                    </button>
                    <button type="submit" id="save-beach-description-btn" class="btn btn-success" style="display: none;">
                        Save Beach Description
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="slider-container" data-resort-id="{{ resort.id }}" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;" id="beachSlider">
                    {% for beach_image in resort.beach_images.all|slice:":3" %}
                        <div class="beach-image-container">
                            <img src="{{ beach_image.image.url }}" alt="Beach Image" class="beach-slide {% if forloop.first %}active{% endif %}" data-image-id="{{ beach_image.id }}">
                            {% if request.user == resort.host %}
                                {% if forloop.counter == 1 %}
                                    <button class="replace-button" data-image-id="{{ beach_image.id }}" style="display:block;">Replace Image</button>
                                {% else %}
                                    <button class="replace-button" data-image-id="{{ beach_image.id }}" style="display:none;">Replace Image</button>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% empty %}
                        <img src="/static/images/fmb.jpg" alt="Default Beach Image 1" class="beach-slide active" data-image-id="default-beach-1">
                    {% endfor %}
                    
                    <!-- Arrows -->
                    <button class="prev" type="button">&#10094;</button>
                    <button class="next" type="button">&#10095;</button>

                </div>
            
                <!-- Upload form -->
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                        <label for="uploadBeachImage" class="custom-file-upload">Upload Image</label>
                        <input type="file" name="beach_image" id="uploadBeachImage" accept="image/*">
                        <button type="button" id="save-beach-image-btn" class="btn btn-primary px-4 py-2 rounded-3 shadow-sm">
                            Save Beach Image
                        </button>
                    {% endif %}
                </div>
            </div>            

        </div>
    </section>
</div>

    
<!-- Activities Section -->
<div class="activities-container" style="background: linear-gradient(to bottom right, #1f5d63, #3f8ca0); padding: 60px 40px; color: white;">
    <section class="activities-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <!-- Activity Image Slider -->
            <div class="slider-container" data-resort-id="{{ resort.id }}" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;" id="activitySlider">
                    {% for activity_image in resort.activity_images.all|slice:":3" %}
                        <div class="activity-image-container">
                            <img src="{{ activity_image.image.url }}"
                                 alt="Activity Image"
                                 class="activity-slide {% if forloop.first %}active{% endif %}"
                                 style="max-width: 100%; border-radius: 10px;"
                                 data-image-id="{{ activity_image.id }}">
            
                            {% if request.user == resort.host %}
                                {% if forloop.counter == 1 %}
                                    <button class="replace-button" data-image-id="{{ activity_image.id }}" style="display:block;">Replace Image</button>
                                {% else %}
                                    <button class="replace-button" data-image-id="{{ activity_image.id }}" style="display:none;">Replace Image</button>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% empty %}
                        <img src="/static/images/fmb.jpg" alt="Default Beach Image 1" class="beach-slide active" data-image-id="default-beach-1">
                    {% endfor %}
            
                    <!-- Arrows -->
                    <button class="prev" type="button" style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10094;</button>
                    <button class="next" type="button" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10095;</button>
                </div>
            
                <!-- Upload form -->
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                        <label for="uploadActivityImage" class="custom-file-upload">Upload Image</label>
                        <input type="file" name="activity_image" id="uploadActivityImage" accept="image/*">
                        <button type="button" id="save-activity-image-btn" class="btn btn-primary px-4 py-2 rounded-3 shadow-sm">
                            Save Activity Image
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Description Right -->
            <div class="description-text" style="flex: 1; max-width: 50%; margin-left: 40px;">
                <h2 style="color: white; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Activities</h2>
                <p id="activity-description" style="font-size: 17px; line-height: 1.6;">{{ resort.activity_description }}</p>
                <textarea name="activity_description" id="edit-activity-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.activity_description }}</textarea>
                <div style="margin-top: 10px;">
                    {% if request.user == resort.host %}
                    <button type="button" id="edit-activity-description-btn" class="btn btn-warning me-2">
                        Edit Activity Description
                    </button>
                    <button type="submit" id="save-activity-description-btn" class="btn btn-success" style="display: none;">
                        Save Activity Description
                    </button>
                    {% endif %}
                </div>
            </div>

        </div>
    </section>
</div>
        <!-- Pricing & Amenities Section -->
        <section class="pricing-amenities">
            <h2>Resort Information</h2>
            <div class="info-container">
                <!-- Amenities Section -->
                <div class="info-box">
                <h3>Our Amenities</h3>
                
                <ul id="amenities-list">
                    {% for amenity in resort.amenities.all %}
                        <li>{{ amenity.name }}</li> 
                    {% endfor %}
                </ul>

                {% if request.user == resort.host %}
                
                <!-- Dropdown for selecting existing amenities -->
                <select id="amenities-dropdown" class="form-select mb-2">
                    <option value="" disabled selected>Select Amenity</option>
                    {% for amenity in amenities %}
                        <option value="{{ amenity.id }}">{{ amenity.name }}</option>
                    {% endfor %}
                </select>
                
                <!-- Input for entering a new amenity -->
                <input type="text" id="new-amenity-input" placeholder="Enter a new amenity" class="form-control mb-2">
                
                <!-- Add Amenity Button -->
                <button type="button" id="add-amenity-btn" class="btn btn-primary px-4 py-2 rounded-3 shadow-sm">
                    Add Amenity
                </button>

                <!-- Hidden field for sending the selected amenity or new amenity to the backend -->
                <input type="hidden" name="new_amenity" id="new-amenity-hidden">
                
                <!-- Invisible submit button, you can trigger this if needed -->
                <button type="submit" style="display: none;"></button>
                {% endif %}
            </div>
    
                <div class="info-box">
                    <h3>Room Rates & Fees</h3>
    
                    <div id="display-mode">
                        <p><strong>Room Price:</strong> <span id="room-rate-text">{{resort.room_rate_display}}</span></p>
                        <p><strong>Kids Entrance Fee:</strong> <span id="kids-fee-text">{{ resort.entrance_kids }}</span></p>
                        <p><strong>Adults Entrance Fee:</strong> <span id="adults-fee-text">{{ resort.entrance_adults }}</span></p>
                        <p><strong>Cottage Price:</strong> <span id="cottage-rate-text">{{resort.cottage_rate_display}}</span></p>
                        <p><strong>Overnight Fee:</strong> <span id="overnight-fee-text">{{ resort.price }}</span></p>
                        {% if request.user == resort.host %}
                        <button type="button" id="edit-btn" class="btn btn-primary px-4 py-2 rounded-3 shadow-sm">
                            Edit Rates
                        </button>
                        {% endif %}
                    </div>
    
                    <div id="edit-mode" style="display: none;">
                        <label>Room Rates:</label>
                        <select name="room_price_range" id="room-rate-input">
                            <option value="Low" {% if resort.room_price_range == "Low" %}selected{% endif %}>Below - 999</option>
                            <option value="Average" {% if resort.room_price_range == "Average" %}selected{% endif %}>Average - 1000-2999</option>
                            <option value="High" {% if resort.room_price_range == "High" %}selected{% endif %}>Above - 3000</option>
                        </select>
                    
                        <label>Kids Entrance Fee:</label>
                        <input type="text" name="entrance_kids" id="kids-fee-input" value="{{ resort.entrance_kids }}">
                    
                        <label>Adults Entrance Fee:</label>
                        <input type="text" name="entrance_adults" id="adults-fee-input" value="{{ resort.entrance_adults }}">
                    
                        <label>Cottage Rates:</label>
                        <select name="cottage_price_range" id="cottage-rate-input">
                            <option value="Low" {% if resort.cottage_price_range == "Low" %}selected{% endif %}>Below - 999</option>
                            <option value="Average" {% if resort.cottage_price_range == "Average" %}selected{% endif %}>Average - 1000-2999</option>
                            <option value="High" {% if resort.cottage_price_range == "High" %}selected{% endif %}>Above - 3000</option>
                        </select>
                    
                        <label>Overnight Fee:</label>
                        <input type="text" name="price" id="overnight-fee-input" value="{{ resort.price }}">
                        {% if request.user == resort.host %}
                        <button type="submit" id="save-btn">Save Rates</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </form>    
<!-- Rating Modal (Hidden by Default) -->
<div id="ratingModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h3>Rate this Resort</h3>
        <div class="stars" style="margin: 10px 0;">
            <span class="star" data-value="1" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="2" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="3" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="4" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="5" style="font-size: 24px; cursor: pointer;">★</span>
        </div>
        <button id="submitRatingBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px;">Submit Rating</button>
    </div>
</div>

{% csrf_token %}
    <div class="comment-wrapper">
        <h3>Comments</h3>
        <hr>
    
        {% for message in resort_messages %}
        <div class="comment">
            <img src="{{ message.user.avatar.url }}" class="avatar" alt="{{ message.user.username }}'s avatar">
    
            <div class="comment-content">
                <div class="comment-header">
                    <a href="{% url 'user-profile' message.user.id %}" class="username">@{{ message.user.username }}</a> 
                    <small class="timestamp">{{ message.created_at|timesince }} ago</small>
                </div>
                <p class="comment-text">{{ message.comment }}</p>
    
                {% if request.user == message.user %}
                <a href="{% url 'delete-message' message.id %}" class="delete-btn">Delete</a>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="no-comments">No comments yet. Be the first to leave one!</p>
        {% endfor %}
    </div>
    

    {% if request.user.is_authenticated %}
    <div class="comment-form">
        <img src="{{ request.user.avatar.url }}" class="avatar">
        <form id="commentForm">
            {% csrf_token %}
            <input type="text" id="commentInput" name="comment" placeholder="Write your comment here..." required>
            <button type="button" id="triggerRatingBeforeComment">Send</button>
        </form>
    </div>
    {% endif %}
    
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    let editBtn = document.getElementById("edit-btn");
    let saveBtn = document.getElementById("save-btn");
    let displayMode = document.getElementById("display-mode");
    let editMode = document.getElementById("edit-mode");

    // Prevent negative values for fee inputs
    const feeInputs = [
        "room-rate-input",
        "kids-fee-input",
        "adults-fee-input",
        "cottage-rate-input",
        "overnight-fee-input"
    ];

    feeInputs.forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener("input", function () {
            // Prevent negative numbers and non-digit characters
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });

    // Edit and Save Room Rates
    editBtn.addEventListener("click", function () {
        displayMode.style.display = "none";
        editMode.style.display = "block";
    });

    saveBtn.addEventListener("click", function () {
        document.getElementById("room-rate-text").innerText = document.getElementById("room-rate-input").value;
        document.getElementById("kids-fee-text").innerText = document.getElementById("kids-fee-input").value;
        document.getElementById("adults-fee-text").innerText = document.getElementById("adults-fee-input").value;
        document.getElementById("cottage-rate-text").innerText = document.getElementById("cottage-rate-input").value;
        document.getElementById("overnight-fee-text").innerText = document.getElementById("overnight-fee-input").value;

        displayMode.style.display = "block";
        editMode.style.display = "none";

        document.querySelector("form").submit();  // Submit the form after saving
    });

    // Function to edit and save description (general function for reuse)
    function editAndSaveDescription(editBtnId, saveBtnId, descriptionId, inputId, fieldName) {
    document.getElementById(editBtnId).addEventListener("click", function () {
        let description = document.getElementById(descriptionId);
        let inputField = document.getElementById(inputId);
        let saveButton = document.getElementById(saveBtnId);

        inputField.value = description.innerText; // Copy current text
        description.style.display = "none"; // Hide text
        inputField.style.display = "block"; // Show textarea
        saveButton.style.display = "block"; // Show save button
        this.style.display = "none"; // Hide edit button
    });

    document.getElementById(saveBtnId).addEventListener("click", function () {
        let description = document.getElementById(descriptionId);
        let inputField = document.getElementById(inputId);
        let editButton = document.getElementById(editBtnId);

        let updatedText = inputField.value;

        // Send only the updated description via AJAX
        fetch(window.location.href, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCSRFToken() // Get CSRF token if using Django
            },
            body: `${fieldName}=${encodeURIComponent(updatedText)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                description.innerText = updatedText; // Update text in UI
                description.style.display = "block"; // Show text
                inputField.style.display = "none"; // Hide textarea
                saveButton.style.display = "none"; // Hide save button
                editButton.style.display = "block"; // Show edit button
            } else {
                alert("Failed to update. Please try again.");
            }
        })
        .catch(error => console.error("Error:", error));
    });
}

// Function to get CSRF token for Django
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Apply to all description sections
editAndSaveDescription("edit-description-btn", "save-description-btn", "resort-description", "edit-description-input", "description");
editAndSaveDescription("edit-room-description-btn", "save-room-description-btn", "room-description", "edit-room-description-input", "room_description");
editAndSaveDescription("edit-beach-description-btn", "save-beach-description-btn", "beach-description", "edit-beach-description-input", "beach_description");
editAndSaveDescription("edit-activity-description-btn", "save-activity-description-btn", "activity-description", "edit-activity-description-input", "activity_description");

    // Hero Section Edit
    document.getElementById("edit-hero-btn").addEventListener("click", function () {
        let heroSubtitle = document.getElementById("hero-subtitle");
        let inputField = document.getElementById("edit-hero-subtitle-input");
        let saveButton = document.getElementById("save-hero-btn");

        inputField.value = heroSubtitle.innerText; // Copy current text
        heroSubtitle.style.display = "none"; // Hide text
        inputField.style.display = "block"; // Show textarea
        saveButton.style.display = "block"; // Show save button
        this.style.display = "none"; // Hide edit button
    });

    document.getElementById("save-hero-btn").addEventListener("click", function () {
        let heroSubtitle = document.getElementById("hero-subtitle");
        let inputField = document.getElementById("edit-hero-subtitle-input");
        let editButton = document.getElementById("edit-hero-btn");

        heroSubtitle.innerText = inputField.value; // Update text
        heroSubtitle.style.display = "block"; // Show text
        inputField.style.display = "none"; // Hide textarea
        this.style.display = "none"; // Hide save button
        editButton.style.display = "block"; // Show edit button

        // Ensure the form will be submitted with new data after saving
        document.querySelector("form").submit();  // Submit the form here
    });

    // Hero image upload functionality
    document.getElementById("uploadHeroImageHero").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("hero").style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Resort image upload functionality
    document.getElementById("uploadResortImage").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("resort-image").src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('add-amenity-btn').addEventListener('click', function() {
    var newAmenityInput = document.getElementById('new-amenity-input');
    var newAmenity = newAmenityInput.value.trim();
    var amenitiesDropdown = document.getElementById('amenities-dropdown');
    var selectedAmenityId = amenitiesDropdown.value;

    if (selectedAmenityId) {
        // Get the name of the selected amenity
        var selectedAmenityName = amenitiesDropdown.options[amenitiesDropdown.selectedIndex].text;

        // Set the hidden input value to the selected amenity name
        document.getElementById('new-amenity-hidden').value = selectedAmenityName;
    } else if (newAmenity) {
        // If there's a new amenity entered, set it as the value to be sent
        document.getElementById('new-amenity-hidden').value = newAmenity;
        
        // Optionally, you can dynamically update the amenities list on the page
        var amenitiesList = document.getElementById('amenities-list');
        var newAmenityLi = document.createElement('li');
        newAmenityLi.textContent = newAmenity;
        amenitiesList.appendChild(newAmenityLi);
        
        // Clear the input
        newAmenityInput.value = '';
    }

    // Trigger the form submit
    document.querySelector('form button[type="submit"]').click();
});
});
let selectedRating = null;

// Show modal when user clicks the "Send" button in comment form
document.getElementById("triggerRatingBeforeComment").addEventListener("click", function() {
    document.getElementById("ratingModal").style.display = "flex";
});

// Handle star click
document.querySelectorAll('.star').forEach(function(star) {
    star.addEventListener('click', function () {
        selectedRating = this.getAttribute('data-value');
        document.querySelectorAll('.star').forEach(function (s) {
            s.style.color = s.getAttribute('data-value') <= selectedRating ? 'gold' : 'gray';
        });
    });
});

// Submit comment + rating
document.getElementById("submitRatingBtn").addEventListener("click", function () {
    const comment = document.getElementById("commentInput").value;
    const resortId = "{{ resort.id }}";  // Injected by Django
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!selectedRating) {
        alert("Please select a rating.");
        return;
    }

    if (!comment.trim()) {
        alert("Please write a comment.");
        return;
    }

    fetch("/rate-resort/" + resortId + "/", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            rating: selectedRating,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Comment and rating submitted!");
            document.getElementById("ratingModal").style.display = "none";
            document.getElementById("commentInput").value = ""; // clear input
            selectedRating = null;
            // Optional: clear star colors
            document.querySelectorAll('.star').forEach(s => s.style.color = 'gray');
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(error => {
        alert("Failed to submit.");
        console.error(error);
    });
});
document.addEventListener('DOMContentLoaded', function () {
    const roomSliderElement = document.getElementById('roomSlider');
    const uploadRoomImageInput = document.getElementById('uploadRoomImage');
    const saveRoomImageBtn = document.getElementById('save-room-image-btn');
    const resortId = document.querySelector('.slider-container')?.dataset.resortId;

    let currentSlide = 0;  // Keep track of the current slide

    // Function to refresh the slider and get the current image count
    function refreshSlides() {
        return Array.from(roomSliderElement.querySelectorAll('.room-slide'));
    }

    // Handle image upload (Add new image)
    saveRoomImageBtn?.addEventListener('click', function (event) {
        event.preventDefault();

        // Check if a file is selected for upload
        const file = uploadRoomImageInput.files[0];
        if (!file) {
            alert('Please select an image.');
            return;
        }

        // Refresh the slides to get the current count
        const slides = refreshSlides();
        if (slides.length >= 3) {
            alert('Maximum of 3 images allowed.');
            return;
        }

        // Prepare form data to upload image
        const formData = new FormData();
        formData.append('room_image', file);

        // Send the image upload request
        fetch(`/resort/${resortId}/upload_room_image_ajax/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.image_url) {
                // Add new image to the slider
                const newImage = document.createElement('img');
                newImage.src = data.image_url;
                newImage.classList.add('room-slide');
                newImage.style.maxWidth = '100%';

                // If there are no images, make the new one active
                if (slides.length === 0) {
                    newImage.classList.add('active');
                }

                // Append new image to the slider
                roomSliderElement.appendChild(newImage);

                // Clear the file input after upload
                uploadRoomImageInput.value = '';
                
                // Refresh the slider and show only the replace button for the new active image
                refreshSlider();
            } else {
                alert('Image upload failed');
            }
        })
        .catch(err => console.error('Error uploading image:', err));
    });

    // Handle image replacement (by clicking "Replace Image" button)
    roomSliderElement?.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('replace-button')) {
            // Prevent the default action (scrolling, anchor link behavior)
            event.preventDefault();
            const imageElement = event.target.closest('.room-image-container').querySelector('.room-slide');
            const imageId = imageElement.dataset.imageId;

            // Trigger file input for replacing image
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none'; // Hide the input initially
            document.body.appendChild(fileInput);

            // When file is selected for replacement
            fileInput.addEventListener('change', function () {
                const file = fileInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('room_image', file);
                formData.append('image_id', imageId); // The ID of the image to replace

                // Send the replace image request
                fetch(`/resort/${resortId}/upload_room_image_ajax/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.image_url) {
                        // Replace the old image with the new one
                        imageElement.src = data.image_url;
                    } else {
                        alert('Image replacement failed');
                    }
                })
                .catch(err => console.error('Error replacing image:', err));

                // Clean up by removing the input field
                document.body.removeChild(fileInput);
            });

            // Open the file input dialog
            fileInput.click();
        }
    });

    // Function to change the slide (Previous or Next)
    function changeSlide(direction) {
        const slides = refreshSlides();
        if (slides.length === 0) return;

        // Hide the current slide
        slides[currentSlide].style.display = 'none';

        // Calculate the new slide index
        currentSlide = (currentSlide + direction + slides.length) % slides.length;

        // Show the new slide
        slides[currentSlide].style.display = 'block';

        // Refresh slider to show only one replace button for the active slide
        refreshSlider();
    }

    // Function to refresh the slider and show only the replace button on the active image
    function refreshSlider() {
        const slides = refreshSlides();
        if (slides.length === 0) return;

        // Hide all replace buttons first
        document.querySelectorAll('.replace-button').forEach(button => {
            button.style.display = 'none';
        });

        // Show the replace button only for the active slide
        const activeSlide = slides[currentSlide];
        const activeButton = activeSlide.closest('.room-image-container').querySelector('.replace-button');
        if (activeButton) {
            activeButton.style.display = 'block'; // Show the button on the active image
        }
    }

    // Add event listeners for the Previous and Next buttons
    const prevButton = document.querySelector('.prev');
    const nextButton = document.querySelector('.next');

    if (prevButton) {
        prevButton.addEventListener('click', function () {
            changeSlide(-1); // Show previous slide
        });
    }

    if (nextButton) {
        nextButton.addEventListener('click', function () {
            changeSlide(1); // Show next slide
        });
    }

    // Initial setup
    refreshSlider();

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const beachSliderElement = document.getElementById('beachSlider');
    const uploadBeachImageInput = document.getElementById('uploadBeachImage');
    const saveBeachImageBtn = document.getElementById('save-beach-image-btn');
    const resortId = document.querySelector('.slider-container')?.dataset.resortId;

    let currentBeachSlide = 0;

    function refreshBeachSlides() {
        return Array.from(beachSliderElement.querySelectorAll('.beach-slide'));
    }

    // Save new beach image
    saveBeachImageBtn?.addEventListener('click', function (event) {
        event.preventDefault();
        const file = uploadBeachImageInput.files[0];
        if (!file) {
            alert('Please select an image.');
            return;
        }

        const slides = refreshBeachSlides();
        if (slides.length >= 3) {
            alert('Maximum of 3 images allowed.');
            return;
        }

        const formData = new FormData();
        formData.append('beach_image', file);

        fetch(`/resort/${resortId}/upload_beach_image_ajax/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.image_url) {
                const newImage = document.createElement('img');
                newImage.src = data.image_url;
                newImage.classList.add('beach-slide');
                newImage.dataset.imageId = data.image_id;

                if (slides.length === 0) {
                    newImage.classList.add('active');
                }

                beachSliderElement.appendChild(newImage);
                uploadBeachImageInput.value = '';
                refreshBeachSlider();
            } else {
                alert('Image upload failed.');
            }
        })
        .catch(err => console.error('Error uploading image:', err));
    });

    // Replace beach image
    beachSliderElement?.addEventListener('click', function (event) {
        if (!event.target.classList.contains('replace-button')) return;

        event.preventDefault();  // Prevent scrolling to top

        const imageElement = event.target.closest('.beach-image-container').querySelector('.beach-slide');
        const imageId = imageElement.dataset.imageId;

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        fileInput.addEventListener('change', function () {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('beach_image', file);
            formData.append('image_id', imageId);

            fetch(`/resort/${resortId}/upload_beach_image_ajax/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.image_url) {
                    imageElement.src = data.image_url;
                } else {
                    alert('Image replacement failed.');
                }
            })
            .catch(err => console.error('Error replacing image:', err));

            document.body.removeChild(fileInput);
        });

        fileInput.click();
    });

    // Slide navigation
    function changeBeachSlide(direction) {
        const slides = refreshBeachSlides();
        if (slides.length === 0) return;

        slides[currentBeachSlide].style.display = 'none';
        currentBeachSlide = (currentBeachSlide + direction + slides.length) % slides.length;
        slides[currentBeachSlide].style.display = 'block';
        refreshBeachSlider();
    }

    // Refresh slider (show only replace button for active image)
    function refreshBeachSlider() {
        const slides = refreshBeachSlides();
        if (slides.length === 0) return;

        document.querySelectorAll('.replace-button').forEach(button => {
            button.style.display = 'none';
        });

        const activeSlide = slides[currentBeachSlide];
        const activeButton = activeSlide.closest('.beach-image-container')?.querySelector('.replace-button');
        if (activeButton) {
            activeButton.style.display = 'block';
        }
    }

    // Navigation buttons
    const prevBeachButton = beachSliderElement?.closest('.slider-container')?.querySelector('.prev');
    const nextBeachButton = beachSliderElement?.closest('.slider-container')?.querySelector('.next');

    prevBeachButton?.addEventListener('click', () => changeBeachSlide(-1));
    nextBeachButton?.addEventListener('click', () => changeBeachSlide(1));

    refreshBeachSlider();

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const activitySliderElement = document.getElementById('activitySlider');
    const uploadActivityImageInput = document.getElementById('uploadActivityImage');
    const saveActivityImageBtn = document.getElementById('save-activity-image-btn');
    const resortId = document.querySelector('.slider-container')?.dataset.resortId;

    let currentActivitySlide = 0;

    function refreshActivitySlides() {
        return Array.from(activitySliderElement.querySelectorAll('.activity-slide'));
    }

    saveActivityImageBtn?.addEventListener('click', function (event) {
        event.preventDefault();
        const file = uploadActivityImageInput.files[0];
        if (!file) {
            alert('Please select an image.');
            return;
        }

        const slides = refreshActivitySlides();
        if (slides.length >= 3) {
            alert('Maximum of 3 images allowed.');
            return;
        }

        const formData = new FormData();
        formData.append('activity_image', file);

        fetch(`/resort/${resortId}/upload_activity_image_ajax/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.image_url) {
                const newImage = document.createElement('img');
                newImage.src = data.image_url;
                newImage.classList.add('activity-slide');
                newImage.dataset.imageId = data.image_id;
                newImage.style.maxWidth = '100%';
                newImage.style.borderRadius = '10px';

                if (slides.length === 0) {
                    newImage.classList.add('active');
                }

                const imageContainer = document.createElement('div');
                imageContainer.classList.add('activity-image-container');
                imageContainer.appendChild(newImage);

                if (slides.length === 0) {
                    const replaceButton = document.createElement('button');
                    replaceButton.classList.add('replace-button');
                    replaceButton.setAttribute('data-image-id', data.image_id);
                    replaceButton.style.display = 'block';
                    replaceButton.textContent = 'Replace Image';
                    imageContainer.appendChild(replaceButton);
                } else {
                    const replaceButton = document.createElement('button');
                    replaceButton.classList.add('replace-button');
                    replaceButton.setAttribute('data-image-id', data.image_id);
                    replaceButton.style.display = 'none';
                    replaceButton.textContent = 'Replace Image';
                    imageContainer.appendChild(replaceButton);
                }

                activitySliderElement.insertBefore(imageContainer, activitySliderElement.querySelector('.prev'));
                uploadActivityImageInput.value = '';
                refreshActivitySlider();
            } else {
                alert('Image upload failed');
            }
        })
        .catch(err => console.error('Error uploading activity image:', err));
    });

    activitySliderElement?.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('replace-button')) {
            event.preventDefault();
            const imageElement = event.target.closest('.activity-image-container').querySelector('.activity-slide');
            const imageId = imageElement.dataset.imageId;

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            fileInput.addEventListener('change', function () {
                const file = fileInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('activity_image', file);
                formData.append('image_id', imageId);

                fetch(`/resort/${resortId}/upload_activity_image_ajax/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.image_url) {
                        imageElement.src = data.image_url;
                    } else {
                        alert('Image replacement failed');
                    }
                })
                .catch(err => console.error('Error replacing activity image:', err));

                document.body.removeChild(fileInput);
            });

            fileInput.click();
        }
    });

    function changeActivitySlide(direction) {
        const slides = refreshActivitySlides();
        if (slides.length === 0) return;

        slides[currentActivitySlide].style.display = 'none';
        currentActivitySlide = (currentActivitySlide + direction + slides.length) % slides.length;
        slides[currentActivitySlide].style.display = 'block';

        refreshActivitySlider();
    }

    function refreshActivitySlider() {
        const slides = refreshActivitySlides();
        if (slides.length === 0) return;

        document.querySelectorAll('.replace-button').forEach(button => {
            button.style.display = 'none';
        });

        const activeSlide = slides[currentActivitySlide];
        activeSlide.classList.add('active');
        const activeButton = activeSlide.closest('.activity-image-container')?.querySelector('.replace-button');
        if (activeButton) {
            activeButton.style.display = 'block';
        }

        slides.forEach((slide, index) => {
            slide.style.display = index === currentActivitySlide ? 'block' : 'none';
        });
    }

    const prevActivityBtn = activitySliderElement.querySelector('.prev');
    const nextActivityBtn = activitySliderElement.querySelector('.next');

    prevActivityBtn?.addEventListener('click', () => changeActivitySlide(-1));
    nextActivityBtn?.addEventListener('click', () => changeActivitySlide(1));

    refreshActivitySlider();

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
</body>
</html>
{% endblock content %}