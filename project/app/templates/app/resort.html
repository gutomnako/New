{% extends 'main.html' %}
{% load static %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMB Resort</title>
    <link rel="stylesheet" href="{% static 'styles/resort.css'%}">
    
</head>
<body>
    <header class="header">
        <div class="logo">
          <h1>BEACHES & RESORT</h1>
        </div>
          <nav class="nav">
              <a href="{% url 'index-view' %}">Home</a>
              <a href="{% url 'home' %}">Beaches & Resorts</a>
              <a href="{% url 'map' %}">Map</a>
              <a href="#">Contact</a>
          </nav>
          <div class="dropdown">
            {% if request.user.is_authenticated %}
              <!-- Hamburger Button -->
              <button class="hamburger-btn" id="hamburgerBtn">
                <i class="bi bi-list"></i> <!-- Bootstrap Icon (Can be replaced by custom icon) -->
              </button>
          
              <!-- Dropdown Menu -->
              <ul class="dropdown-menu" id="dropdownMenu">
                  <li><a class="dropdown-item" href="{% url 'user-profile' request.user.pk %}">Settings</a></li>
                  <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
              </ul>
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
            {% endif %}
          </div>
      </header>
    <form action="{% url 'update_resort' resort.id %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
    
       <!-- Hero Section -->
<header class="hero" id="hero" style="background-image: url('{% if resort.hero_image %}{{ resort.hero_image.url }}{% else %}/static/images/fmb.jpg{% endif %}');">
    <div class="hero-content">
        <h1>Welcome to {{ resort.name }}</h1>

        <!-- Mini Description (Editable) -->
        <div class="hero-description-wrapper">
            <p id="hero-subtitle">{{ resort.mini_description }}</p>
            <textarea name="mini_description" id="edit-hero-subtitle-input" class="editable-textarea" style="display: none;">{{ resort.mini_description }}</textarea>
            <div class="description-buttons">
                <button type="button" id="edit-hero-btn" class="edit-btn">Edit Description</button>
                <button type="submit" id="save-hero-btn" class="save-btn" style="display: none;">Save Description</button>
            </div>
        </div>

        <!-- Upload Hero Image -->
        <label for="uploadHeroImageHero" class="custom-file-upload">Upload Image</label>
        <input type="file" name="hero_image" id="uploadHeroImageHero" accept="image/*" hidden>
        <button type="submit" class="save-image-btn">Save Hero Image</button>
    </div>
</header>
    
        <!-- Resort Description Section -->
        <section class="resort-description">
            <div class="description-container">
                <div class="description-text">
                    <h2 style="color: black;">About {{ resort.name }}</h2>
                    <p id="resort-description" style="color: black;">{{ resort.description }}</p>
                    <textarea name="description" id="edit-description-input" style="display: none;">{{ resort.description }}</textarea>
                    <button type="button" id="edit-description-btn">Edit Description</button>
                    <button type="submit" id="save-description-btn" style="display: none;">Save Description</button>
                </div>
    
                <!-- Resort Image Upload -->
                <div class="description-image">
                    <img id="resort-image" src="{{ resort.resort_image.url|default:'/static/images/fmb.jpg' }}" alt="Resort Image">
                    <label for="uploadResortImage" class="custom-file-upload">Upload Image</label>
                    <input type="file" name="resort_image" id="uploadResortImage" accept="image/*">
                    <button type="submit" id="save-resort-image-btn" class="save-image-btn">Save Resort Image</button>
                </div>
            </div>
        </section>
    
        <!-- Rooms Section -->
<div class="rooms-container" style="background: linear-gradient(to bottom right, #1f5d63, #3f8ca0); padding: 60px 40px; color: white;">
    <section class="room-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <!-- Image Slider Left -->
            <div class="slider-container" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;">
                    <button class="prev" type="button" onclick="changeSlide(-1)" style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10094;</button>
                    <img id="sliderImage" 
                         src="{% if resort.roomimage %}{{ resort.roomimage.url }}{% else %}/static/images/fmb.jpg{% endif %}" 
                         alt="Room Image" style="max-width: 100%; border-radius: 10px;">
                    <button class="next" type="button" onclick="changeSlide(1)" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10095;</button>
                </div>
                <div style="margin-top: 10px;">
                    <label for="uploadRoomImage" class="custom-file-upload">Upload Image</label>
                    <input type="file" name="roomimage" id="uploadRoomImage" accept="image/*">
                    <button type="submit" id="save-room-image-btn" class="save-image-btn">Save Room Image</button>
                </div>
            </div>

            <!-- Description Right -->
            <div class="description-text" style="flex: 1; max-width: 50%;">
                <h2 style="color: white; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Rooms</h2>
                <p id="room-description" style="font-size: 17px; line-height: 1.6;">{{ resort.room_description }}</p>
                <textarea name="room_description" id="edit-room-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.room_description }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" id="edit-room-description-btn">Edit Room Description</button>
                    <button type="submit" id="save-room-description-btn" style="display: none;">Save Room Description</button>
                </div>
            </div>

        </div>
    </section>
</div>

<!-- Beach Section -->
<div class="beach-container" style="background: #ffffff; padding: 60px 40px; color: #333;">
    <section class="beach-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <!-- Text Left -->
            <div class="description-text" style="flex: 1; max-width: 50%;">
                <h2 style="color: #333; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Beach</h2>
                <p id="beach-description" style="font-size: 17px; line-height: 1.6; color: #333;">{{ resort.beach_description }}</p>
                <textarea name="beach_description" id="edit-beach-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.beach_description }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" id="edit-beach-description-btn">Edit Beach Description</button>
                    <button type="submit" id="save-beach-description-btn" style="display: none;">Save Beach Description</button>
                </div>
            </div>

            <!-- Image Right -->
            <div class="slider-container" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;">
                    <button class="prev" type="button" onclick="changeBeachSlide(-1)" style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10094;</button>
                    <img id="sliderImage2" 
                         src="{% if resort.beachimage %}{{ resort.beachimage.url }}{% else %}/static/images/fmb.jpg{% endif %}" 
                         alt="Beach Image" style="max-width: 100%; border-radius: 10px;">
                    <button class="next" type="button" onclick="changeBeachSlide(1)" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10095;</button>
                </div>
                <div style="margin-top: 10px;">
                    <label for="uploadBeachImage" class="custom-file-upload">Upload Image</label>
                    <input type="file" name="beachimage" id="uploadBeachImage" accept="image/*">
                    <button type="submit" id="save-beach-image-btn" class="save-image-btn">Save Beach Image</button>
                </div>
            </div>

        </div>
    </section>
</div>

    
<!-- Activities Section -->
<div class="activities-container" style="background: linear-gradient(to bottom right, #1f5d63, #3f8ca0); padding: 60px 40px; color: white;">
    <section class="activities-description">
        <div class="description-container" style="display: flex; justify-content: space-between; align-items: center; gap: 40px; flex-wrap: wrap;">
            
            <!-- Image Slider Left -->
            <div class="slider-container" style="flex: 1; max-width: 50%; text-align: center;">
                <div style="position: relative;">
                    <button class="prev" type="button" onclick="changeActivity(-1)" style="position: absolute; left: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10094;</button>
                    <img id="activity-sliderImage" 
                         src="{% if resort.activities_image %}{{ resort.activities_image.url }}{% else %}/static/images/fmb.jpg{% endif %}" 
                         alt="Activity Image" style="max-width: 100%; border-radius: 10px;">
                    <button class="next" type="button" onclick="changeActivity(1)" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 24px;">&#10095;</button>
                </div>
                <div style="margin-top: 10px;">
                    <label for="uploadActivityImage" class="custom-file-upload">Upload Image</label>
                    <input type="file" name="activities_image" id="uploadActivityImage" accept="image/*">
                    <button type="submit" id="save-activity-image-btn" class="save-image-btn">Save Activity Image</button>
                </div>
            </div>

            <!-- Description Right -->
            <div class="description-text" style="flex: 1; max-width: 50%;">
                <h2 style="color: white; font-size: 32px; font-weight: bold; margin-bottom: 16px;">Activities</h2>
                <p id="activity-description" style="font-size: 17px; line-height: 1.6;">{{ resort.activity_description }}</p>
                <textarea name="activity_description" id="edit-activity-description-input" style="display: none; width: 100%; padding: 10px;">{{ resort.activity_description }}</textarea>
                <div style="margin-top: 10px;">
                    <button type="button" id="edit-activity-description-btn">Edit Activity Description</button>
                    <button type="submit" id="save-activity-description-btn" style="display: none;">Save Activity Description</button>
                </div>
            </div>

        </div>
    </section>
</div>
        <!-- Pricing & Amenities Section -->
        <section class="pricing-amenities">
            <h2>Resort Information</h2>
            <div class="info-container">
                <!-- Amenities Section -->
                <div class="info-box">
                    <h3>Our Amenities</h3>
                    
                    <ul id="amenities-list">
                        {% for amenity in resort.amenities.all %}
                            <li>{{ amenity.name }}</li> 
                        {% endfor %}
                    </ul>
            
                    <input type="text" id="new-amenity-input" placeholder="Enter a new amenity">
                    <button type="button" id="add-amenity-btn">Add Amenity</button>
            
                    <input type="hidden" name="new_amenity" id="new-amenity-hidden" value="{{ new_amenity }}">
                    
                    <button type="submit" style="display: none;"></button> 
                </div>
    
                <div class="info-box">
                    <h3>Room Rates & Fees</h3>
    
                    <div id="display-mode">
                        <p><strong>Room Rates:</strong> <span id="room-rate-text">{{ resort.price_per_night }}</span> per night</p>
                        <p><strong>Kids:</strong> <span id="kids-fee-text">{{ resort.entrance_kids }}</span></p>
                        <p><strong>Adults:</strong> <span id="adults-fee-text">{{ resort.entrance_adults }}</span></p>
                        <p><strong>Cottage Rates:</strong> <span id="cottage-rate-text">{{ resort.cottage }}</span></p>
                        <p><strong>Overnight Fee:</strong> <span id="overnight-fee-text">{{ resort.price }}</span> per night</p>
    
                        <button type="button" id="edit-btn">Edit Rates</button>
                    </div>
    
                    <div id="edit-mode" style="display: none;">
                        <label>Room Rates:</label>
                        <input type="text" name="price_per_night" id="room-rate-input" value="{{ resort.price_per_night }}">
    
                        <label>Kids Fee:</label>
                        <input type="text" name="entrance_kids" id="kids-fee-input" value="{{ resort.entrance_kids }}">
    
                        <label>Adults Fee:</label>
                        <input type="text" name="entrance_adults" id="adults-fee-input" value="{{ resort.entrance_adults }}">
    
                        <label>Cottage Rates:</label>
                        <input type="text" name="cottage" id="cottage-rate-input" value="{{ resort.cottage }}">
    
                        <label>Overnight Fee:</label>
                        <input type="text" name="price" id="overnight-fee-input" value="{{ resort.price }}">
    
                        <button type="submit" id="save-btn">Save Rates</button>
                    </div>
                </div>
            </div>
        </section>
    </form>    
<!-- Rating Modal (Hidden by Default) -->
<div id="ratingModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h3>Rate this Resort</h3>
        <div class="stars" style="margin: 10px 0;">
            <span class="star" data-value="1" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="2" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="3" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="4" style="font-size: 24px; cursor: pointer;">★</span>
            <span class="star" data-value="5" style="font-size: 24px; cursor: pointer;">★</span>
        </div>
        <button id="submitRatingBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px;">Submit Rating</button>
    </div>
</div>

{% csrf_token %}
    <div class="comment-wrapper">
        <h3>Comments</h3>
        <hr>
    
        {% for message in resort_messages %}
        <div class="comment">
            <img src="{{ message.user.avatar.url }}" class="avatar" alt="{{ message.user.username }}'s avatar">
    
            <div class="comment-content">
                <div class="comment-header">
                    <a href="{% url 'user-profile' message.user.id %}" class="username">@{{ message.user.username }}</a> 
                    <small class="timestamp">{{ message.created_at|timesince }} ago</small>
                </div>
                <p class="comment-text">{{ message.comment }}</p>
    
                {% if request.user == message.user %}
                <a href="{% url 'delete-message' message.id %}" class="delete-btn">Delete</a>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="no-comments">No comments yet. Be the first to leave one!</p>
        {% endfor %}
    </div>
    

    {% if request.user.is_authenticated %}
    <div class="comment-form">
        <img src="{{ request.user.avatar.url }}" class="avatar">
        <form id="commentForm">
            {% csrf_token %}
            <input type="text" id="commentInput" name="comment" placeholder="Write your comment here..." required>
            <button type="button" id="triggerRatingBeforeComment">Send</button>
        </form>
    </div>
    {% endif %}
    
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    let editBtn = document.getElementById("edit-btn");
    let saveBtn = document.getElementById("save-btn");
 
    let displayMode = document.getElementById("display-mode");
    let editMode = document.getElementById("edit-mode");

    // Edit and Save Room Rates
    editBtn.addEventListener("click", function () {
        displayMode.style.display = "none";
        editMode.style.display = "block";
    });

    saveBtn.addEventListener("click", function () {
        document.getElementById("room-rate-text").innerText = document.getElementById("room-rate-input").value;
        document.getElementById("kids-fee-text").innerText = document.getElementById("kids-fee-input").value;
        document.getElementById("adults-fee-text").innerText = document.getElementById("adults-fee-input").value;
        document.getElementById("cottage-rate-text").innerText = document.getElementById("cottage-rate-input").value;
        document.getElementById("overnight-fee-text").innerText = document.getElementById("overnight-fee-input").value;

        displayMode.style.display = "block";
        editMode.style.display = "none";

        document.querySelector("form").submit();  // Submit the form after saving
    });

    // Function to edit and save description (general function for reuse)
    function editAndSaveDescription(editBtnId, saveBtnId, descriptionId, inputId, fieldName) {
    document.getElementById(editBtnId).addEventListener("click", function () {
        let description = document.getElementById(descriptionId);
        let inputField = document.getElementById(inputId);
        let saveButton = document.getElementById(saveBtnId);

        inputField.value = description.innerText; // Copy current text
        description.style.display = "none"; // Hide text
        inputField.style.display = "block"; // Show textarea
        saveButton.style.display = "block"; // Show save button
        this.style.display = "none"; // Hide edit button
    });

    document.getElementById(saveBtnId).addEventListener("click", function () {
        let description = document.getElementById(descriptionId);
        let inputField = document.getElementById(inputId);
        let editButton = document.getElementById(editBtnId);

        let updatedText = inputField.value;

        // Send only the updated description via AJAX
        fetch(window.location.href, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCSRFToken() // Get CSRF token if using Django
            },
            body: `${fieldName}=${encodeURIComponent(updatedText)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                description.innerText = updatedText; // Update text in UI
                description.style.display = "block"; // Show text
                inputField.style.display = "none"; // Hide textarea
                saveButton.style.display = "none"; // Hide save button
                editButton.style.display = "block"; // Show edit button
            } else {
                alert("Failed to update. Please try again.");
            }
        })
        .catch(error => console.error("Error:", error));
    });
}

// Function to get CSRF token for Django
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Apply to all description sections
editAndSaveDescription("edit-description-btn", "save-description-btn", "resort-description", "edit-description-input", "description");
editAndSaveDescription("edit-room-description-btn", "save-room-description-btn", "room-description", "edit-room-description-input", "room_description");
editAndSaveDescription("edit-beach-description-btn", "save-beach-description-btn", "beach-description", "edit-beach-description-input", "beach_description");
editAndSaveDescription("edit-activity-description-btn", "save-activity-description-btn", "activity-description", "edit-activity-description-input", "activity_description");

    // Hero Section Edit
    document.getElementById("edit-hero-btn").addEventListener("click", function () {
        let heroSubtitle = document.getElementById("hero-subtitle");
        let inputField = document.getElementById("edit-hero-subtitle-input");
        let saveButton = document.getElementById("save-hero-btn");

        inputField.value = heroSubtitle.innerText; // Copy current text
        heroSubtitle.style.display = "none"; // Hide text
        inputField.style.display = "block"; // Show textarea
        saveButton.style.display = "block"; // Show save button
        this.style.display = "none"; // Hide edit button
    });

    document.getElementById("save-hero-btn").addEventListener("click", function () {
        let heroSubtitle = document.getElementById("hero-subtitle");
        let inputField = document.getElementById("edit-hero-subtitle-input");
        let editButton = document.getElementById("edit-hero-btn");

        heroSubtitle.innerText = inputField.value; // Update text
        heroSubtitle.style.display = "block"; // Show text
        inputField.style.display = "none"; // Hide textarea
        this.style.display = "none"; // Hide save button
        editButton.style.display = "block"; // Show edit button

        // Ensure the form will be submitted with new data after saving
        document.querySelector("form").submit();  // Submit the form here
    });

    // Hero image upload functionality
    document.getElementById("uploadHeroImageHero").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("hero").style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Resort image upload functionality
    document.getElementById("uploadResortImage").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("resort-image").src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Beach image upload functionality
    document.getElementById("uploadBeachImage").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("sliderImage").src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Activities image upload functionality
    document.getElementById("uploadActivityImage").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("activity-sliderImage").src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('add-amenity-btn').addEventListener('click', function() {
    var newAmenityInput = document.getElementById('new-amenity-input');
    var newAmenity = newAmenityInput.value.trim();
    
    if (newAmenity) {
        // Set the hidden input value to the new amenity
        document.getElementById('new-amenity-hidden').value = newAmenity;
        
        // Optionally, you can also dynamically update the amenities list on the page
        var amenitiesList = document.getElementById('amenities-list');
        var newAmenityLi = document.createElement('li');
        newAmenityLi.textContent = newAmenity;
        amenitiesList.appendChild(newAmenityLi);
        
        // Clear the input
        newAmenityInput.value = '';
        
        // Trigger the form submit
        document.querySelector('form button[type="submit"]').click();
    }
});
});
document.addEventListener('DOMContentLoaded', function () {
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');

  if (hamburgerBtn && dropdownMenu) {
    hamburgerBtn.addEventListener('click', function() {
      // Toggle the 'open' class on the dropdown element
      dropdownMenu.parentElement.classList.toggle('open');
    });
  }
});
let selectedRating = null;

// Show modal when user clicks the "Send" button in comment form
document.getElementById("triggerRatingBeforeComment").addEventListener("click", function() {
    document.getElementById("ratingModal").style.display = "flex";
});

// Handle star click
document.querySelectorAll('.star').forEach(function(star) {
    star.addEventListener('click', function () {
        selectedRating = this.getAttribute('data-value');
        document.querySelectorAll('.star').forEach(function (s) {
            s.style.color = s.getAttribute('data-value') <= selectedRating ? 'gold' : 'gray';
        });
    });
});

// Submit comment + rating
document.getElementById("submitRatingBtn").addEventListener("click", function () {
    const comment = document.getElementById("commentInput").value;
    const resortId = "{{ resort.id }}";  // Injected by Django
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!selectedRating) {
        alert("Please select a rating.");
        return;
    }

    if (!comment.trim()) {
        alert("Please write a comment.");
        return;
    }

    fetch("/rate-resort/" + resortId + "/", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            rating: selectedRating,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Comment and rating submitted!");
            document.getElementById("ratingModal").style.display = "none";
            document.getElementById("commentInput").value = ""; // clear input
            selectedRating = null;
            // Optional: clear star colors
            document.querySelectorAll('.star').forEach(s => s.style.color = 'gray');
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(error => {
        alert("Failed to submit.");
        console.error(error);
    });
});
</script>
</body>
</html>
{% endblock content %}